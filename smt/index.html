<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SMT Solvers - Verification For Dummies: SMT and Induction by OCamlPro</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item "><a href="../preface/index.html"><strong aria-hidden="true">2.</strong> Preface</a></li><li class="chapter-item expanded "><a href="../smt/index.html" class="active"><strong aria-hidden="true">3.</strong> SMT Solvers</a></li><li class="chapter-item "><a href="../trans/index.html"><strong aria-hidden="true">4.</strong> Transition Systems</a></li><li class="chapter-item "><a href="../trans_smt/index.html"><strong aria-hidden="true">5.</strong> SMT and Transition Systems</a></li><li class="chapter-item "><a href="../bmc/index.html"><strong aria-hidden="true">6.</strong> Unrolling and BMC</a></li><li class="chapter-item "><a href="../mikino_bmc/index.html"><strong aria-hidden="true">7.</strong> BMC: Mikino</a></li><li class="chapter-item "><a href="../induction/index.html"><strong aria-hidden="true">8.</strong> Induction</a></li><li class="chapter-item "><a href="../mikino_induction/index.html"><strong aria-hidden="true">9.</strong> Induction: Mikino and Step Cex-s</a></li><li class="chapter-item "><a href="../strength/index.html"><strong aria-hidden="true">10.</strong> Candidate Strengthening</a></li><li class="chapter-item "><a href="../conclusion/index.html"><strong aria-hidden="true">11.</strong> Conclusion</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Verification For Dummies: SMT and Induction by OCamlPro</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="smt-solvers"><a class="header" href="#smt-solvers">SMT Solvers</a></h1>
<blockquote>
<p>SMT solvers are basic building blocks for most modern verification tools. While studying SMT
solvers is particularly rewarding for developing such tools, understanding SMT forces to grasp
concepts that are very useful even for high-level users. Later chapters will rely heavily on SMT
solvers and readers are encouraged to run and modify examples themselves, or even create new ones.</p>
</blockquote>
<p><br />
</p>
<p>Let's go over a few theory-level notions before we actually start playing with SMT solvers. A
<strong>S</strong>atisfiability <strong>M</strong>odulo <strong>T</strong>heory (SMT) solver is a solver for establishing whether some
constraints expressed in <strong>M</strong>any-<strong>S</strong>orted <strong>F</strong>irst <strong>O</strong>rder <strong>L</strong>ogic (MSFOL) are
<em>satisfiable</em>. Let's unpack this.</p>
<p>First, MSFOL is built on FOL (<strong>F</strong>irst <strong>O</strong>rder <strong>L</strong>ogic), which basically means <em>&quot;boolean
formulas&quot;</em>. For instance, <code>a ∧ (false ∨ b ∨ c)</code> is a FOL formula, where <code>∧</code> is conjunction (<code>&amp;&amp;</code>)
and <code>∨</code> is disjunction (<code>||</code>). So this formula <em>evaluates</em> to <code>true</code> if and only if <code>a</code> is <code>true</code>
and either <code>b</code> or <code>c</code> is <code>true</code> (since <code>false</code> tends not to be <code>true</code>). We can represent this
formula as a tree, where leaves are boolean literals and nodes are boolean operators.</p>
<pre><code class="language-text"> ┌───∧───┐
 │       │
 a    ┌──∨──┬───────┐
      │     │       │
      │     │       │
    false   b       c
</code></pre>
<p>The leaves of the tree are <em>atoms</em>. MSFOL essentially extends FOL by allowing atoms to be formulas
in other theories such as integers, strings, arrays, <em>etc.</em> For instance, with <code>x</code> and <code>y</code> integers
and <code>arr</code> an array:</p>
<pre><code class="language-text">   ┌───∧─────┐
   │         │
 x &gt; 7    ┌──∨────┬───────┐
          │       │       │
          │       │       │
        false   y ≤ x   arr[y] = x + 1
</code></pre>
<p>Note that the last atom, <code>arr[y] = x + 1</code>, mixes array selection <code>arr[y]</code> with addition over
integers <code>x + 1</code>.</p>
<h2 id="z3"><a class="header" href="#z3">Z3</a></h2>
<p>Examples in the next sections (and the next chapter) will rely on the <a href="https://github.com/Z3Prover/z3" title="Z3 on github">Z3 SMT solver</a> to
actually run. You can build it from source or recover a binary from the <a href="https://github.com/Z3Prover/z3/releases" title="Z3's releases on github">release page</a>.
The version should not matter too much for what we'll do, but for reference this guide used
<code>v4.8.12</code>.</p>
<p>From this point forward I assume readers have a Z3 binary called <code>z3</code> in their path. That is,
running the command <code>z3 -version</code> should not fail and produce an output similar to</p>
<pre><code class="language-text">Z3 version 4.8.13 - 64 bit
</code></pre>
<p>While I recommend Z3, other efficient solvers exist and include <a href="https://alt-ergo.ocamlpro.com" title="Alt-Ergo homepage">Alt-Ergo</a>, <a href="https://cvc4.github.io/" title="CVC4 homepage">CVC4</a> and
<a href="https://yices.csl.sri.com" title="Yices 2 homepage">Yices 2</a>. Solvers tend to be good at distinct kinds of problem from each other, and
verification frameworks routinely run several of them in parallel, wait for the quickest answer,
and discard solver instances that are still running.</p>
<!-- Last, while we recommend having Z3 available locally, you can run the examples in this section
using only the [Z3 online playground][z3 online]. Beware that all following chapters about induction
require to have Z3 in your path. -->
<h2 id="satisfiability"><a class="header" href="#satisfiability">Satisfiability</a></h2>
<p>Formula satisfiability is concerned about whether it is possible to make some formula evaluate to
<code>true</code>. More precisely, is it possible to find a valuation for the variables appearing in the
formula under which the formula is <code>true</code>. Such a valuation is called a <em>model</em> of the formula. Let
us write a tiny example and start running Z3 to play with satisfiability directly.</p>
<blockquote>
<p>To be precise, <em>SAT</em> stands for the <em>boolean satisfiability problem</em>, which deals with finding
models for purely boolean formulas. <em>&quot;SMT&quot;</em> adds <em>&quot;Modulo Theory&quot;</em> to <em>&quot;Satisfiability&quot;</em> to
specify that atoms of the formula can mention theories different from booleans (integers, reals,
arrays, <em>etc.</em>) in its atoms, and that models must respect the rules of these theories.</p>
</blockquote>
<h2 id="smt-lib-2"><a class="header" href="#smt-lib-2">SMT-LIB 2</a></h2>
<p>For simplicity's sake, let's only allow atoms to mention integers. Consider the following formula.</p>
<pre><code class="language-text">(declare-const x Int)
(declare-const y Int)

   ┌───∧─────┐
   │         │
 x &gt; 7    ┌──∨──────┐
          │         │
          │         │
        y = 2*x   x = 11
</code></pre>
<p>The first two lines declare <em>&quot;constants&quot;</em> <code>x</code> and <code>y</code>. As programmers, we can see them as
<em>&quot;variables&quot;</em> in the sense that they represent an unknown value of type <code>Int</code>. This syntax comes
from the <a href="http://smtlib.cs.uiowa.edu" title="SMT-LIB homepage">SMT-LIB 2 standard</a>, which is the standard language for interacting with SMT
solvers. Most, if not all, SMT solvers support SMT-LIB 2 input.</p>
<p>Of course, the ASCII art tree representing the formula is <em>not</em> legal SMT-LIB 2. An SMT-LIB 2 script
declares constants (and more) and uses these constants to <em>assert</em> formulas, <em>i.e.</em> specify to the
solver what the constraints are.</p>
<p>Also, SMT-LIB formulas are written using <em>prefix notation</em> (or <em>Polish notation</em>). For instance, <code>y = 2*x</code> would be written <code>(= y (* 2 x))</code>. This is a compromise between ease of printing/parsing and
human readability. SMT-LIB is really meant to be used by programs to communicate, not for humans to
actually write by hand. Still, it is readable enough for pedagogic and debugging purposes.</p>
<blockquote>
<p><a href="https://code.visualstudio.com" title="VS Code homepage">VS Code</a> has an extension for SMT-LIB syntax highlighting (<code>.smt2</code> files). The pieces of SMT-LIB
code I will show in this book will not have syntax highlighting, unfortunately. I apologize
for this problem, and encourage readers to copy these pieces of code in an editor that supports
SMT-LIB using the button at the top-right of the code blocks.</p>
</blockquote>
<p>Anyway, an SMT-LIB assertion of our running example would look like this:</p>
<pre><code class="language-text">(declare-const x Int)
(declare-const y Int)

(assert (and
	(&gt; x 7)
	(or (= y (* 2 x)) (= x 11))
))

(check-sat)
</code></pre>
<p>The <code>assert</code> command feeds a constraint to the solver. Next, we can ask the solver to check
the satisfiability of all the constraints (of which there is just one here) with <code>check-sat</code>.</p>
<h2 id="playing-with-z3-sat"><a class="header" href="#playing-with-z3-sat">Playing with Z3: <code>sat</code></a></h2>
<p>Let's now run Z3 on this tiny example. Create a file <code>test.smt2</code> and copy the content of the
SMT-LIB script above. No special option is needed and you should get the following output.</p>
<pre><code class="language-text">❯ z3 test.smt2
sat
</code></pre>
<p>Z3 simply answered <code>sat</code>, indicating that the formula is <em>&quot;satisfiable&quot;</em>: there exists a model (a
valuation of the variables) that make our constraints <code>true</code>. This is nice, but it would be better
if Z3 could give us a model to make sure it is not lying to us (it's not). We can do so by adding a
<code>get-model</code> command after the <code>check-sat</code>. (Note that <code>get-model</code> is <strong>only</strong> legal after a
<code>check-sat</code> yielded <code>sat</code>.)</p>
<pre><code class="language-text">(declare-const x Int)
(declare-const y Int)

(assert (and
	(&gt; x 7)
	(or (= y (* 2 x)) (= x 11))
))

(check-sat)
(get-model)
</code></pre>
<p>After updating <code>test.smt2</code>, running Z3 again will produce a model. You might not get exactly the
same model as the one reported here depending on the precise version of Z3 you are using and
possibly other factors (such as your operating system).</p>
<pre><code class="language-text">❯ z3 test.smt2
sat
(
  (define-fun y () Int
    16)
  (define-fun x () Int
    8)
)
</code></pre>
<p>The model is slightly cryptic. Z3 defines <code>x</code> and <code>y</code> as functions taking no arguments, which means
that they are constants. This is because all functions are <em>pure</em> in SMT-LIB, meaning they always
produce the same output when given the same inputs. Hence, a function with no arguments can only
produce one value, and is therefore the same as a constant. In fact, <code>(define-fun &lt;ident&gt; () &lt;type&gt; &lt;val&gt;)</code> is the same as <code>(define-const &lt;ident&gt; &lt;type&gt; &lt;val&gt;)</code>, and the <code>(declare-const &lt;ident&gt; &lt;type&gt;)</code> we used in the SMT-LIB script is equivalent to <code>(declare-fun &lt;ident&gt; () &lt;type&gt;)</code>. Again,
in SMT-LIB (and pure functional languages) a constant is just a function that takes no argument.</p>
<p>This valuation is a model because <code>(&gt; x 7) ≡ (&gt; 8 7)</code> holds and so does <code>(= y (* 2 x)) ≡ (= 16 (* 2 8))</code>.</p>
<p><br />
</p>
<p>Now, remember that we can assert more than one constraint, and that Z3 works on the conjunction of
all constraints. In our running example, our only constraint is a conjunction, meaning we could
write it as two constraints.</p>
<pre><code class="language-text">(declare-const x Int)
(declare-const y Int)

(assert (&gt; x 7))
(assert (or (= y (* 2 x)) (= x 11)))

(check-sat)
(get-model)
</code></pre>
<p>Let's now add the constraint that <code>y</code> is an odd number: <code>(= (mod y 2) 1)</code>. This should void the
previous model, and more generally any model that relies on making <code>(= y (* 2 x))</code> true to satisfy
the constraints. (Since <code>y</code> would need to be both even and odd.)</p>
<pre><code class="language-text">(declare-const x Int)
(declare-const y Int)

(assert (&gt; x 7))
(assert (or (= y (* 2 x)) (= x 11)))
(assert (= (mod y 2) 1))

(check-sat)
(get-model)
</code></pre>
<p>We now get</p>
<pre><code class="language-text">❯ z3 test.smt2
sat
(
  (define-fun x () Int
    11)
  (define-fun y () Int
    1)
)
</code></pre>
<p>As expected, Z3 now has to make the second constraint <code>true</code> through <code>(= x 11)</code>.</p>
<h2 id="playing-with-z3-unsat"><a class="header" href="#playing-with-z3-unsat">Playing with Z3: <code>unsat</code></a></h2>
<p>Let's add another constraint to make these constraints unsatisfiable. In the latest version of our
example, Z3 has no choice but to have <code>x</code> be <code>11</code> since it is the only way to verify the second
constraint (because the third constraint prevents <code>y</code> from being even).</p>
<p>We can simply constrain <code>x</code> to be even (which prevents <code>x</code> to be <code>11</code>), which we will write as &quot;<code>x</code>
cannot be odd&quot;.</p>
<pre><code class="language-text">(declare-const x Int)
(declare-const y Int)

(assert (&gt; x 7))
(assert (or (= y (* 2 x)) (= x 11)))
(assert (= (mod y 2) 1))

(assert (not (= (mod x 2) 1)))

(check-sat)
(get-model)
</code></pre>
<p>Z3 knows exactly what we are doing and replies that the formula is unsatisfiable.</p>
<pre><code class="language-text">❯ z3 test.smt2
unsat
(error &quot;line 11 column 10: model is not available&quot;)
</code></pre>
<p>We get an error though, because it does not make sense to ask for a model if the formula is
unsatisfiable. <em>&quot;Unsatisfiable&quot;</em>, or <em>unsat</em>, means <em>&quot;has no model&quot;</em> (<em>i.e.</em> no valuation of the
variables can make all constraints true).</p>
<p><br />
</p>
<p>Now, what does this unsatisfiability result tell us? One way to see it is to consider the first
three constraints as some form of context. That is, the first three constraints correspond to some
point in a program where there are two unknown values <code>x</code> and <code>y</code>, and the first three constraints
encode what we know to be true about these values.</p>
<p>The last constraint can be seen as a question. Say that at that point in the program, there is an
assertion that <code>x</code> must be odd. We want to verify that this assert can never fail. From this point
of view, then the latest version of our running example amounts to asking &quot;given the context (first
three constraints), is it possible for <code>x</code> to <strong>not</strong> be odd?&quot;. In other words, we are asking Z3 to
find some values that both verify our context and <strong>falsify</strong> the program's assertion.</p>
<p>Z3 answers &quot;no&quot;: in this context, it is not possible for <code>x</code> not to be odd. This means that Z3
proved for us that the program's assert statement can never fail (and can be compiled away).</p>
<p>What if, with different constraints, the negation of the program's assert statement was
satisfiable? Then, <a href="#playing-with-z3-sat">as we saw in the previous section</a>, Z3 can give us a
<em>model</em>: a valuation of all the (relevant) variables involved in the check. this constitutes a
<em>counterexample</em>, which shows how it is possible to verify the whole context but still falsify the
program assertion (<em>i.e</em> satisfy the SMT-LIB-level <code>(assert (not &lt;program_assertion&gt;))</code>).</p>
<h2 id="outro"><a class="header" href="#outro">Outro</a></h2>
<p>SMT solvers are extremely powerful, flexible and expressive tools. <em>Powerful</em> because they are
highly optimized tools constantly improved by ongoing theoretical and practical research.
<em>Flexible</em> because many different theories are available, allowing to manipulate integers, strings,
arrays, algebraic data types, <em>etc.</em> And <em>expressive</em> because a great deal of verification problems
are amenable to SMT without too much trouble.</p>
<p>One such verification problem is <em>declarative transition system (induction-based) verification</em>, as
we will see in the following chapters.</p>
<!-- [z3 online]: https://rise4fun.com/z3 (Z3's online interface) -->

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../preface/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../trans/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../preface/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../trans/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
